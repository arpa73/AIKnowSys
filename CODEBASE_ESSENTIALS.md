# aiknowsys - Codebase Essentials

> **Last Updated:** January 29, 2026  
> **Purpose:** AI-Powered Development Workflow Template  
> **Maintainer:** arpa73

---

## 1. Technology Snapshot

| Component | Technology |
|-----------|------------|
| Runtime | Node.js 20+ |
| Language | JavaScript (ES Modules) |
| CLI Framework | Commander.js 14.x |
| User Prompts | Inquirer.js 13.x |
| Terminal UI | Chalk 5.x, Ora 9.x |
| Package Manager | npm |
| Distribution | npm registry |

---

## 2. Validation Matrix

| Command | Purpose | Expected |
|---------|---------|----------|
| `npm test` | Run unit tests | All 255+ tests pass |
| `npm run lint` | Lint codebase | No errors or warnings |
| `npm run test:coverage` | Code coverage | >80% coverage on lib/ |
| `node bin/cli.js --help` | CLI works | Shows help without errors |
| `node bin/cli.js scan --dir .` | Scan command | Generates draft ESSENTIALS |
| `node bin/cli.js check` | Validation + bloat detection | ESSENTIALS <800 lines |
| `node bin/cli.js validate-deliverables` | Deliverables validation | All checks pass |
| `node bin/cli.js validate-deliverables --full` | Comprehensive validation | All checks pass (includes fresh init) |
| `node bin/cli.js compress-essentials --analyze` | Preview compression | Shows opportunities |
| `npm pack --dry-run` | Package contents | Lists correct files |

---

## 3. Project Structure

```
aiknowsys/
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îî‚îÄ‚îÄ cli.js              # CLI entry point
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ commands/           # Command implementations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init.js         # New project setup (entry point)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init/           # Init command modules
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js    # Barrel exports
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants.js # Stack configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prompts.js  # Interactive prompts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ display.js  # Output formatting
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ openspec.js # OpenSpec integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scan.js         # Codebase scanner
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrate.js      # Migration workflow
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ install-agents.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ install-skills.js
‚îÇ   ‚îî‚îÄ‚îÄ utils.js            # Shared utilities
‚îú‚îÄ‚îÄ templates/              # All template files
‚îÇ   ‚îú‚îÄ‚îÄ agents/             # Agent templates
‚îÇ   ‚îú‚îÄ‚îÄ skills/             # Skill templates (user-facing only)
‚îÇ   ‚îú‚îÄ‚îÄ git-hooks/          # TDD git hooks
‚îÇ   ‚îú‚îÄ‚îÄ scripts/            # TDD install scripts
‚îÇ   ‚îú‚îÄ‚îÄ workflows/          # GitHub Actions workflows
‚îÇ   ‚îú‚îÄ‚îÄ hooks/              # VSCode session hooks (optional)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks.json      # Hook configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session-start.js # Auto-load context
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session-end.js  # Auto-save state
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation-reminder.cjs # Stop hook (validation enforcement)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tdd-reminder.cjs # PreToolUse hook (TDD reminders)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ collaboration-check.mjs # Concurrent work detection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ performance-monitor.cjs # Performance tracking
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migration-check.cjs # Version mismatch detection
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ doc-sync.cjs # Documentation staleness tracking
‚îÇ   ‚îú‚îÄ‚îÄ stacks/             # Stack-specific templates
‚îÇ   ‚îú‚îÄ‚îÄ AGENTS.template.md
‚îÇ   ‚îú‚îÄ‚îÄ CODEBASE_ESSENTIALS.template.md
‚îÇ   ‚îú‚îÄ‚îÄ CODEBASE_ESSENTIALS.minimal.template.md
‚îÇ   ‚îî‚îÄ‚îÄ CODEBASE_CHANGELOG.template.md
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ skills/             # Universal skills (includes maintainer-only)
‚îÇ       ‚îú‚îÄ‚îÄ deliverable-review/  # Maintainer skill (maintainer: true)
‚îÇ       ‚îú‚îÄ‚îÄ _skill-template/     # Maintainer skill (maintainer: true)
‚îÇ       ‚îú‚îÄ‚îÄ ai-friendly-documentation/  # User skills (distributed)
‚îÇ       ‚îú‚îÄ‚îÄ context7-usage/
‚îÇ       ‚îú‚îÄ‚îÄ dependency-management/
‚îÇ       ‚îú‚îÄ‚îÄ feature-implementation/
‚îÇ       ‚îú‚îÄ‚îÄ refactoring-workflow/
‚îÇ       ‚îú‚îÄ‚îÄ skill-creator/
‚îÇ       ‚îú‚îÄ‚îÄ skill-validation/
‚îÇ       ‚îú‚îÄ‚îÄ tdd-workflow/
‚îÇ       ‚îî‚îÄ‚îÄ validation-troubleshooting/
‚îú‚îÄ‚îÄ .aiknowsys/             # AI knowledge system (user workspace)
‚îÇ   ‚îú‚îÄ‚îÄ performance-history.json # Performance tracking (gitignored, last 100 runs)
‚îÇ   ‚îú‚îÄ‚îÄ CURRENT_PLAN.md     # Team index (auto-generated by sync-plans)
‚îÇ   ‚îú‚îÄ‚îÄ PLAN_*.md           # Implementation plans
‚îÇ   ‚îú‚îÄ‚îÄ plans/              # Multi-developer plan tracking (committed)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md       # Workflow explanation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ active-<username>.md  # Per-developer active plan pointer
‚îÇ   ‚îú‚îÄ‚îÄ reviews/            # Multi-developer reviews (gitignored)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md       # Workflow explanation (committed)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PENDING_<username>.md  # Per-developer review files
‚îÇ   ‚îú‚îÄ‚îÄ learned/            # Project-specific patterns (committed)
‚îÇ   ‚îú‚îÄ‚îÄ personal/           # Personal patterns (gitignored)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <username>/     # Per-developer personal patterns
‚îÇ   ‚îî‚îÄ‚îÄ sessions/           # Session notes (gitignored)
‚îú‚îÄ‚îÄ scripts/                # Bash alternatives (legacy)
‚îú‚îÄ‚îÄ examples/               # Stack-specific examples
‚îú‚îÄ‚îÄ docs/                   # Documentation
‚îî‚îÄ‚îÄ package.json
```

### Maintainer vs User Content

Skills with `maintainer: true` in frontmatter are for AIKnowSys development only.
They stay in `.github/skills/` but are NOT synced to `templates/skills/`.

**User skills (9):** Distributed via `npx aiknowsys init`  
**Maintainer skills (2):** `deliverable-review`, `_skill-template`

---

## 4. Core Patterns

### CLI Command Structure
```javascript
// All commands follow this pattern:
import { createLogger } from '../logger.js';

export async function commandName(options) {
  const targetDir = path.resolve(options.dir);
  const silent = options._silent || false;
  const log = createLogger(silent);
  
  // 1. Display header
  log.header('Command Title', 'üéØ');
  
  // 2. Interactive prompts (if needed, skip if silent)
  if (!silent) {
    const answers = await inquirer.prompt([...]);
  }
  
  // 3. Spinner for long operations (conditional on silent mode)
  const spinner = silent ? null : ora('Doing work...').start();
  
  // 4. Execute logic
  try {
    // ... work
    if (spinner) spinner.succeed('Done');
    
    // Return data for test assertions
    return { success: true, data: result };
  } catch (error) {
    if (spinner) spinner.fail('Failed');
    log.error('Failed: ' + error.message);
    throw error;  // Testable - don't use process.exit()
  }
  
  // 5. Display next steps
  log.cyan('üìñ Next steps:');
}
```

### Logger Pattern
All commands use `createLogger(silent)` for consistent, testable output. See [learned skill](.aiknowsys/learned/logger-pattern.md) for detailed usage, methods, and examples.

```javascript
import { createLogger } from '../logger.js';
const log = createLogger(silent);  // silent = true/false
```

### Inquirer Prompts
Use `'rawlist'` instead of `'list'` for VS Code terminal compatibility. See [learned skill](.aiknowsys/learned/inquirer-compatibility.md) for details.

```javascript
// Use rawlist (numbered options) - works everywhere
await inquirer.prompt([{
  type: 'rawlist',
  name: 'choice',
  message: 'Select option:',
  choices: [...],
  default: 1
}]);
```

### Template Variable Replacement
```javascript
// Use {{VARIABLE}} syntax in templates
copyTemplate(source, dest, {
  '{{PROJECT_NAME}}': answers.projectName,
  '{{DATE}}': new Date().toLocaleDateString(...)
});
```

### Silent Mode for Nested Calls
```javascript
// Commands accept _silent option for programmatic use
export async function installAgents(options) {
  const silent = options._silent || false;
  if (!silent) {
    console.log(...);
  }
}
```

### Progress Indicators
For detailed guidance on progress indicators and spinners, see the [learned skill](.aiknowsys/learned/progress-indicators.md). This project uses ora spinners with three distinct patterns depending on the operation type (file processing, multi-step checks, or sequential phases). Always call `succeed()`, `fail()`, or `info()` to clear spinner state.

### Plan Management Pattern
**Multiple concurrent plans** enabled via pointer system.

**Multi-Developer Workflow (Mandatory v0.9.0+):**

**Plan Pointers:**
- **plans/active-<username>.md:** Personal active plan pointer (committed to git)
- **CURRENT_PLAN.md:** Team index aggregating all developers' plans (auto-generated, committed)
- **Username:** Extracted from `git config user.name`, normalized (lowercase, spaces ‚Üí hyphens)

**Individual Plans (.aiknowsys/PLAN_*.md):**
- Full implementation details (committed to git)
- Progress tracking with checkboxes
- Phase/step breakdown
- Status lifecycle: üìã PLANNED ‚Üí üéØ ACTIVE ‚Üí üîÑ PAUSED or ‚úÖ COMPLETE or ‚ùå CANCELLED

**Workflow:**
1. **@Planner** creates detailed PLAN_*.md
2. **Developer** updates `plans/active-<username>.md` to point to plan
3. **Developer** runs `npx aiknowsys sync-plans` to regenerate team index
4. **Developer** follows active plan, tracking progress in PLAN_*.md
5. **Completed plans** remain visible in team index with ‚úÖ status

**Benefits:**
- No merge conflicts on plan tracking (each dev has own pointer)
- Team visibility (CURRENT_PLAN.md shows everyone's active work)
- Solo developers work the same way (just one entry in team index)
- Clean git history (auto-generated file committed, not manually edited)

**Migration:**
- **Existing projects (pre-v0.9.0):** Run `npx aiknowsys migrate-to-multidev` to convert single-dev ‚Üí multi-dev
- **New projects:** Run `npx aiknowsys init` (creates multi-dev structure by default)

See: [AGENTS.md](AGENTS.md#plan-management)

---

## 5. Critical Invariants

1. **ES Modules Only**
   - All **internal** files use `import`/`export`, never `require()`
   - package.json has `"type": "module"`
   - **Exception:** Templates distributed to user projects may use `.cjs` for compatibility
     - Example: VSCode hooks, git hook installer
     - Reason: User projects may not use ES modules

2. **Absolute Paths Required**
   - Always use `path.resolve()` for user-provided paths
   - Use `getPackageDir()` for template paths

3. **Graceful Failures**
   - All commands must handle missing files/directories
   - Show helpful error messages, not stack traces

4. **Template Preservation**
   - Never modify files in `templates/` - they're the source of truth
   - User customization happens in generated files

5. **Template Structure Integrity**
   - When AI fills CODEBASE_ESSENTIALS.md, NEVER change section headings
   - Replace `{{PLACEHOLDERS}}` with real values, not generic placeholders
   - Preserve template structure exactly (don't rename sections)
   - Example: Keep "Testing Patterns" as-is, don't change to "Testing Guidelines"
   - Example: Replace `{{TEST_ORGANIZATION}}` with actual test structure, not "Manual testing only"

6. **Backwards Compatibility**
   - Bash scripts in `scripts/` must remain functional
   - npm CLI is additive, not replacement

7. **Test-Driven Development (TDD)**
   - Write tests BEFORE implementation for new features
   - Follow RED-GREEN-REFACTOR cycle
   - Keep tests fast and focused
   - **Exception:** Configuration-only changes (e.g., adding properties to const objects) don't require new tests if existing tests already cover the logic using that configuration
   - See `.github/skills/tdd-workflow/SKILL.md` for detailed guidance

8. **Deliverables Consistency**
   - Templates (`templates/` directory) are **deliverables** distributed to users
   - ANY change to core functionality MUST update corresponding templates
   - Templates must match non-template equivalents (agents, workflows, docs)
   - Breaking changes MUST be reflected in all deliverables before release
   - **Validation:**
     - Run `npx aiknowsys validate-deliverables` before commits/releases
     - Pre-commit hook automatically validates when templates/ changed
     - quality-check command includes deliverables validation
     - Use `--fix` flag to auto-fix simple pattern issues
   - **Critical:** Shipping broken templates breaks user experience
   - See [.aiknowsys/learned/deliverables-validation.md](.aiknowsys/learned/deliverables-validation.md) for patterns

---

## 6. Common Gotchas

See [learned skill](.aiknowsys/learned/common-gotchas.md) for detailed solutions to common issues:
- ESM `__dirname` not available (use `fileURLToPath(import.meta.url)`)
- Chalk 5.x is ESM-only (must use `import`, not `require()`)
- Template variables in markdown (use regex escaping)
- Path separators (always use `path.join()`, never string concatenation)
- Import extensions required (must include `.js`)
- JSON import syntax (use import assertions)
- **CommonJS in ES module projects**: Use `.cjs` extension when you need CommonJS (require/module.exports) in a project with `"type": "module"` in package.json. Example: VSCode hooks use `.cjs` because stdin JSON parsing is simpler with CommonJS than ES module async imports.

---

## 7. Extending AIKnowSys

For adding new commands or skills, see [learned skill](.aiknowsys/learned/extending-aiknowsys.md).

**Quick reference:**
- Commands: Create `lib/commands/my-command.js`, register in `bin/cli.js`, add tests
- Skills: Create `templates/skills/my-skill/SKILL.md`, register in `install-skills.js`
- Follow existing patterns, write tests first (TDD)

**Universal Learned Skills:**
- `plan-management.md` - Multi-plan concurrent workflow pattern
- `essentials-compression.md` - ESSENTIALS bloat detection and compression

### When to Document Where

**Add to CODEBASE_ESSENTIALS.md when:**
- Core architecture decision (technology choice)
- Universal pattern (all files of type X follow this)
- Critical invariant (cannot be violated)
- Project structure change (new directories, file organization)
- Core command/feature that ships with aiknowsys

**Add to .aiknowsys/learned/ when:**
- Project-specific discovery (specific to this codebase)
- Workaround for library/framework quirk
- Optional technique that improves quality
- Pattern that emerged from practice (not designed upfront)
- Error resolution that might recur

**Why this matters:** Keeps ESSENTIALS focused on architecture while allowing learned skills to capture project evolution. Target: ESSENTIALS <800 lines.

---

## 8. Testing Philosophy

We practice **Test-Driven Development (TDD)** for all new features. See [.github/skills/tdd-workflow/SKILL.md](.github/skills/tdd-workflow/SKILL.md) for detailed guidance.

**Quick summary:**
1. Write test first (RED) - Define expected behavior
2. Watch it fail - Verify test catches the issue
3. Implement minimal code (GREEN) - Make the test pass  
4. Refactor - Clean up while tests stay green

**Testing Standards:**
- **Test Runner:** Node.js built-in (`node:test`) - ZERO external dependencies
- **Assertion Library:** `node:assert` module
- **Structure:** `describe()` for test suites, `it()` for individual tests
- **Assertions:** Use `assert.strictEqual()`, `assert.ok()`, `assert.match()`, etc.
- **Mocking:** Use `beforeEach()` / `afterEach()` for setup/teardown

**Example test structure:**
```javascript
import { describe, it, beforeEach, afterEach } from 'node:test';
import assert from 'node:assert';

describe('Feature Name', () => {
  beforeEach(() => {
    // Setup
  });

  it('should do something specific', () => {
    const result = functionUnderTest();
    assert.strictEqual(result, expectedValue);
  });

  afterEach(() => {
    // Cleanup
  });
});
```

**Running tests:**
```bash
npm test                             # Run all tests
node --test test/init.test.js --watch  # Watch mode
```

---

## 9. Release Checklist

- [ ] Bump version: `npm version patch/minor/major` (auto-updates package.json)
- [ ] Test all commands locally
- [ ] Run `npm pack --dry-run` to verify package contents
- [ ] Update CODEBASE_CHANGELOG.md
- [ ] `npm publish`

---

*This file is the single source of truth for AI assistants working on aiknowsys.*
