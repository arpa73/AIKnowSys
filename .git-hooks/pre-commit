#!/bin/bash
#
# Pre-commit Git Hook - TDD Compliance Check
#
# Ensures that changes to lib/ directory include corresponding test changes
# Helps prevent violating Critical Invariant #7 (Test-Driven Development)
#
# Installation:
#   chmod +x .git/hooks/pre-commit
#   (This file should be copied to .git/hooks/pre-commit)
#

echo "üîç Running TDD compliance check..."

# Check if lib/ files are staged
LIB_STAGED=$(git diff --cached --name-only | grep "^lib/" || true)

if [ -n "$LIB_STAGED" ]; then
    echo "üìù Detected staged changes in lib/:"
    echo "$LIB_STAGED" | sed 's/^/   - /'
    
    # Check if test/ files are also staged
    TEST_STAGED=$(git diff --cached --name-only | grep "^test/" || true)
    
    if [ -z "$TEST_STAGED" ]; then
        echo ""
        echo "‚ö†Ô∏è  WARNING: Staging lib/ changes without test/ changes"
        echo ""
        echo "Critical Invariant #7: Test-Driven Development (TDD)"
        echo "‚Üí Tests should be written BEFORE implementation"
        echo "‚Üí Follow RED-GREEN-REFACTOR cycle"
        echo ""
        echo "Did you follow TDD?"
        echo "  üî¥ RED: Write failing test first"
        echo "  üü¢ GREEN: Implement minimal code to pass"
        echo "  üîµ REFACTOR: Clean up while keeping tests green"
        echo ""
        
        read -p "Continue with commit anyway? (y/N) " -n 1 -r
        echo
        
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo ""
            echo "‚ùå Commit aborted"
            echo "üí° Tip: Stage your test files with: git add test/"
            echo ""
            exit 1
        else
            echo ""
            echo "‚ö†Ô∏è  Proceeding without test changes (you chose to override)"
            echo "üìù Consider documenting this TDD violation in CODEBASE_CHANGELOG.md"
            echo ""
        fi
    else
        echo "‚úÖ Found staged test changes:"
        echo "$TEST_STAGED" | sed 's/^/   - /'
        echo ""
        echo "‚úÖ TDD compliance check passed!"
    fi
else
    echo "‚ÑπÔ∏è  No changes in lib/ directory"
fi

echo ""
