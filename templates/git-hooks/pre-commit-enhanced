#!/bin/bash
# Enhanced pre-commit hook with AIKnowSys integration
# This hook runs quality checks before allowing commits
# 
# Features:
# - Runs full test suite (blocks on failure)
# - Deliverables validation (blocks if templates/ changed)
#   * Only runs when templates/ directory files are staged
#   * Validates templates match non-template equivalents
#   * Prevents shipping broken templates to users
#   * Auto-fix available: npx aiknowsys validate-deliverables --fix
#   * Can bypass with: git commit --no-verify (not recommended)
# - Optional quality checks (warns only)
# - ESSENTIALS size validation (warns if >800 lines)
#
# Installation:
#   chmod +x .git/hooks/pre-commit
#   ln -s ../../templates/git-hooks/pre-commit-enhanced .git/hooks/pre-commit
#
# Or use: node bin/cli.js install-git-hooks

set -e  # Exit on error

echo "üîç Running pre-commit validation..."
echo ""

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "‚ö†Ô∏è  Not in a git repository - skipping pre-commit checks"
  exit 0
fi

# 1. Run tests (BLOCKING - must pass to commit)
echo "üìã Step 1/4: Running tests..."
if npm test > /dev/null 2>&1; then
  echo "  ‚úÖ All tests passed"
else
  echo ""
  echo "  ‚ùå Tests failed - commit blocked"
  echo ""
  echo "  Fix failing tests before committing."
  echo "  Run 'npm test' to see failures."
  echo ""
  exit 1
fi

# 2. Deliverables validation (BLOCKING if templates/ changed)
echo "üìã Step 2/4: Deliverables validation..."
if git diff --cached --name-only | grep -q '^templates/'; then
  echo "  üìù Templates changed - validating deliverables..."
  
  if command -v node > /dev/null 2>&1 && [ -f "bin/cli.js" ]; then
    if node bin/cli.js validate-deliverables --silent; then
      echo "  ‚úÖ Deliverables validation passed"
    else
      echo ""
      echo "  ‚ùå Deliverables validation failed - commit blocked"
      echo ""
      echo "  Templates must match non-template equivalents."
      echo "  Run: npx aiknowsys validate-deliverables"
      echo "  Fix: npx aiknowsys validate-deliverables --fix"
      echo "  Or skip: git commit --no-verify (not recommended)"
      echo ""
      exit 1
    fi
  else
    echo "  ‚äñ Deliverables check skipped (CLI not available)"
  fi
else
  echo "  ‚äñ No template changes detected"
fi

# 3. Run quality checks (WARNING - doesn't block)
echo "üìã Step 3/4: Quality checks..."
if command -v node > /dev/null 2>&1 && [ -f "bin/cli.js" ]; then
  if node bin/cli.js check --silent 2>&1 | grep -q "Issues found"; then
    echo "  ‚ö†Ô∏è  Quality issues detected (review recommended)"
    echo "  Run 'node bin/cli.js check' for details"
  else
    echo "  ‚úÖ Quality checks passed"
  fi
else
  echo "  ‚äñ Quality check skipped (CLI not available)"
fi

# 4. Check ESSENTIALS size (WARNING - doesn't block)
echo "üìã Step 4/4: ESSENTIALS validation..."
if [ -f "CODEBASE_ESSENTIALS.md" ]; then
  LINES=$(wc -l < CODEBASE_ESSENTIALS.md | tr -d ' ')
  
  if [ "$LINES" -gt 800 ]; then
    echo "  ‚ö†Ô∏è  ESSENTIALS.md is $LINES lines (target: <800)"
    echo "  Consider: node bin/cli.js compress-essentials"
  else
    echo "  ‚úÖ ESSENTIALS size OK ($LINES lines)"
  fi
else
  echo "  ‚äñ ESSENTIALS check skipped (file not found)"
fi

echo ""
echo "‚úÖ Pre-commit validation passed"
echo ""

exit 0

