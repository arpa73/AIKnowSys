#!/bin/bash
#
# Pre-commit Git Hook - TDD Compliance & Linting Check
#
# 1. Runs ESLint on staged files
# 2. Ensures that changes to lib/ directory include corresponding test changes
#
# Installation:
#   chmod +x .git/hooks/pre-commit
#   (This file should be copied to .git/hooks/pre-commit)
#

# Run linter on staged files
echo "ğŸ” Running ESLint on staged files..."

# Get staged .js files
STAGED_JS=$(git diff --cached --name-only --diff-filter=ACM | grep "\.js$" || true)

if [ -n "$STAGED_JS" ]; then
    echo "ğŸ“ Linting staged JavaScript files..."
    
    # Run eslint on staged files
    if ! npx eslint $STAGED_JS; then
        echo ""
        echo "âŒ ESLint failed!"
        echo "ğŸ’¡ Fix linting errors or run: npm run lint:fix"
        echo ""
        exit 1
    fi
    
    echo "âœ… ESLint passed!"
    echo ""
fi

echo "ğŸ” Running TDD compliance check..."

# Check if lib/ files are staged
LIB_STAGED=$(git diff --cached --name-only | grep "^lib/" || true)

if [ -n "$LIB_STAGED" ]; then
    echo "ğŸ“ Detected staged changes in lib/:"
    echo "$LIB_STAGED" | sed 's/^/   - /'
    
    # Check if test/ files are also staged
    TEST_STAGED=$(git diff --cached --name-only | grep "^test/" || true)
    
    if [ -z "$TEST_STAGED" ]; then
        echo ""
        echo "âš ï¸  WARNING: Staging lib/ changes without test/ changes"
        echo ""
        echo "Critical Invariant #7: Test-Driven Development (TDD)"
        echo "â†’ Tests should be written BEFORE implementation"
        echo "â†’ Follow RED-GREEN-REFACTOR cycle"
        echo ""
        echo "Did you follow TDD?"
        echo "  ğŸ”´ RED: Write failing test first"
        echo "  ğŸŸ¢ GREEN: Implement minimal code to pass"
        echo "  ğŸ”µ REFACTOR: Clean up while keeping tests green"
        echo ""
        
        read -p "Continue with commit anyway? (y/N) " -n 1 -r
        echo
        
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo ""
            echo "âŒ Commit aborted"
            echo "ğŸ’¡ Tip: Stage your test files with: git add test/"
            echo ""
            exit 1
        else
            echo ""
            echo "âš ï¸  Proceeding without test changes (you chose to override)"
            echo "ğŸ“ Consider documenting this TDD violation in CODEBASE_CHANGELOG.md"
            echo ""
        fi
    else
        echo "âœ… Found staged test changes:"
        echo "$TEST_STAGED" | sed 's/^/   - /'
        echo ""
        echo "âœ… TDD compliance check passed!"
    fi
else
    echo "â„¹ï¸  No changes in lib/ directory"
fi

echo ""
