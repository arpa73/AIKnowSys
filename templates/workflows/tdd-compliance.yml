name: TDD Compliance Check

# Runs on pull requests and pushes to enforce Test-Driven Development
# Ensures that new code in lib/ comes with corresponding tests in test/

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'lib/**'
      - 'test/**'
  push:
    branches: [ main, develop ]
    paths:
      - 'lib/**'
      - 'test/**'

jobs:
  check-tdd-compliance:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need to compare with previous commit
      
      - name: Check for new code without tests
        run: |
          echo "ðŸ” Checking TDD compliance..."
          
          # Check if lib/ directory changed
          LIB_CHANGED=$(git diff --name-only HEAD^..HEAD | grep "^lib/" || true)
          
          if [ -n "$LIB_CHANGED" ]; then
            echo "âœ“ Detected changes in lib/ directory:"
            echo "$LIB_CHANGED"
            
            # Analyze the nature of changes
            REQUIRES_TESTS=false
            CONFIG_ONLY=true
            REFACTOR_FILES=""
            
            for file in $LIB_CHANGED; do
              # Get the diff for this file
              DIFF=$(git diff HEAD^..HEAD -- "$file")
              REFACTOR_SCORE=0
              REFACTOR_TYPES=""
              
              # === REFACTOR DETECTION PATTERNS ===
              
              # 1. Detect comment/JSDoc changes only (highest priority)
              COMMENT_LINES=$(echo "$DIFF" | grep -E "^[\+\-]\s*(//|/\*|\*)" | wc -l)
              TOTAL_LINES=$(echo "$DIFF" | grep -E "^[\+\-]" | grep -v "^[\+\-]\s*$" | wc -l)
              
              if [ "$TOTAL_LINES" -gt 0 ] && [ "$COMMENT_LINES" -eq "$TOTAL_LINES" ]; then
                echo "  ðŸ“ $file: Documentation-only changes"
                REFACTOR_SCORE=100
                REFACTOR_TYPES="docs"
                REFACTOR_FILES="$REFACTOR_FILES$file|$REFACTOR_TYPES "
                continue
              fi
              
              # 2. Detect import statement changes only
              IMPORT_ONLY=$(echo "$DIFF" | grep -E "^[\+\-]\s*import " | wc -l)
              if [ "$IMPORT_ONLY" -gt 0 ] && [ "$IMPORT_ONLY" -eq "$TOTAL_LINES" ]; then
                echo "  ðŸ”„ $file: Import reordering only (refactor)"
                REFACTOR_SCORE=100
                REFACTOR_TYPES="import-reorder"
                REFACTOR_FILES="$REFACTOR_FILES$file|$REFACTOR_TYPES "
                continue
              fi
              
              # 3. Detect variable renames (eslint unused param fixes: x â†’ _x)
              if echo "$DIFF" | grep -E "^\-.*\b([a-zA-Z_][a-zA-Z0-9_]*)\b" > /dev/null; then
                # Extract variable names from removed lines and check if they appear prefixed with _ in added lines
                RENAMED_VARS=$(echo "$DIFF" | grep -E "^\-" | grep -oE '\b[a-zA-Z_][a-zA-Z0-9_]*\b' | sort -u)
                for var in $RENAMED_VARS; do
                  if echo "$DIFF" | grep -E "^\+.*\b_$var\b" > /dev/null 2>&1; then
                    echo "  ðŸ”„ $file: Variable rename detected ($var â†’ _$var)"
                    REFACTOR_SCORE=$((REFACTOR_SCORE + 10))
                    REFACTOR_TYPES="${REFACTOR_TYPES:+$REFACTOR_TYPES,}rename"
                    break
                  fi
                done
              fi
              
              # 4. Detect || to ?? operator changes (nullish coalescing refactor)
              if echo "$DIFF" | grep -E "^\-.*\|\|" > /dev/null && echo "$DIFF" | grep -E "^\+.*\?\?" > /dev/null; then
                # Check if it's a default value pattern
                if echo "$DIFF" | grep -E "(const|let|var) .* = .* (\?\?|\|\|) " > /dev/null; then
                  echo "  ðŸ”„ $file: Operator equivalence (|| â†’ ??) detected (refactor)"
                  REFACTOR_SCORE=$((REFACTOR_SCORE + 15))
                  REFACTOR_TYPES="${REFACTOR_TYPES:+$REFACTOR_TYPES,}operator"
                fi
              fi
              
              # === LOGIC CHANGE DETECTION ===
              
              # Determine if refactor vs new logic based on score
              if [ "$REFACTOR_SCORE" -ge 30 ]; then
                echo "  âœ… $file: Likely refactor (score: $REFACTOR_SCORE, types: $REFACTOR_TYPES)"
                REFACTOR_FILES="$REFACTOR_FILES$file|$REFACTOR_TYPES "
                CONFIG_ONLY=false
                continue
              fi
              
              # Check if diff contains logic changes (not just const/config)
              # Logic indicators: new functions, if/else, loops, class methods
              if echo "$DIFF" | grep -E "^\+.*(function |class |if \(|for \(|while \(|switch \(|async |await |=>)" > /dev/null; then
                echo "  ðŸ“ $file: Logic changes detected (refactor score: $REFACTOR_SCORE)"
                REQUIRES_TESTS=true
                CONFIG_ONLY=false
              # Check for new exports (might be new functions)
              elif echo "$DIFF" | grep -E "^\+.*export (async )?function" > /dev/null; then
                echo "  ðŸ“ $file: New exported function detected"
                REQUIRES_TESTS=true
                CONFIG_ONLY=false
              # Check if only const object properties changed (configuration)
              elif echo "$DIFF" | grep -E "^\+.*\s+['\"]?[a-zA-Z0-9-]+['\"]?:\s*\{" > /dev/null && \
                   ! echo "$DIFF" | grep -E "^\+.*(function|class|if|for|while|=>)" > /dev/null; then
                echo "  âš™ï¸  $file: Configuration-only changes (const object properties)"
              else
                # Default: assume it needs tests unless it's clearly just comments/docs
                if echo "$DIFF" | grep -E "^\+.*[^/]" | grep -v "^\+\s*//" | grep -v "^\+\s*\*" > /dev/null; then
                  echo "  âš ï¸  $file: Changes detected (score: $REFACTOR_SCORE - assuming logic change)"
                  REQUIRES_TESTS=true
                  CONFIG_ONLY=false
                fi
              fi
            done
            
            # Check for test changes
            TEST_CHANGED=$(git diff --name-only HEAD^..HEAD | grep "^test/" || true)
            
            if [ "$REQUIRES_TESTS" = "true" ] && [ -z "$TEST_CHANGED" ]; then
              echo ""
              echo "âŒ TDD VIOLATION DETECTED"
              echo ""
              echo "New logic was added to lib/ without corresponding test changes."
              echo ""
              echo "Critical Invariant #7: Test-Driven Development (TDD)"
              echo "â†’ Write tests BEFORE implementation for new features"
              echo "â†’ Follow RED-GREEN-REFACTOR cycle"
              echo ""
              echo "Files with NEW LOGIC (need tests):"
              for file in $LIB_CHANGED; do
                # Check if this file is not in refactor list
                if ! echo "$REFACTOR_FILES" | grep -q "$file|"; then
                  echo "  - $file"
                fi
              done
              
              if [ -n "$REFACTOR_FILES" ]; then
                echo ""
                echo "Files with REFACTORS (no tests needed):"
                echo "$REFACTOR_FILES" | tr ' ' '\n' | while IFS='|' read -r fname ftype; do
                  [ -n "$fname" ] && echo "  - $fname ($ftype)"
                done
              fi
              
              echo ""
              echo "Expected: Changes in test/ directory"
              echo "Found: No test changes"
              echo ""
              echo "ðŸ“š See: .github/skills/feature-implementation/SKILL.md"
              echo "ðŸ“š See: AGENTS.md (Step 3: TDD Requirement)"
              exit 1
            elif [ "$CONFIG_ONLY" = "true" ]; then
              echo ""
              echo "âœ… Configuration-only changes detected!"
              echo "   No new tests required (existing tests cover config usage)"
              echo ""
              echo "ðŸ’¡ TIP: Verify existing tests still pass with new config values"
            elif [ -n "$REFACTOR_FILES" ] && [ -z "$TEST_CHANGED" ]; then
              echo ""
              echo "âœ… REFACTOR DETECTED - TDD check passed!"
              echo ""
              echo "Detected refactor patterns:"
              echo "$REFACTOR_FILES" | tr ' ' '\n' | while IFS='|' read -r fname ftype; do
                [ -n "$fname" ] && echo "  - $fname: $ftype"
              done
              echo ""
              echo "ðŸ’¡ TIP: Existing tests cover refactored code."
              echo "   Run 'npm test' to verify no regressions."
            elif [ -n "$TEST_CHANGED" ]; then
              echo "âœ“ Found corresponding test changes:"
              echo "$TEST_CHANGED"
              echo ""
              echo "âœ… TDD compliance check passed!"
            else
              echo ""
              echo "âœ… TDD compliance check passed!"
              echo "   (No logic changes requiring new tests detected)"
            fi
          else
            echo "â„¹ï¸  No changes in lib/ directory - skipping TDD check"
          fi
      
      - name: Verify tests exist for new features
        run: |
          echo ""
          echo "ðŸ“Š Test Coverage Summary:"
          
          # Count test files
          TEST_COUNT=$(find test -name "*.test.js" 2>/dev/null | wc -l)
          echo "Total test files: $TEST_COUNT"
          
          # Count lib files
          LIB_COUNT=$(find lib -name "*.js" 2>/dev/null | wc -l)
          echo "Total lib files: $LIB_COUNT"
          
          echo ""
          echo "ðŸ’¡ Remember: Tests should be written BEFORE implementation!"
          echo "   ðŸ”´ RED â†’ ðŸŸ¢ GREEN â†’ ðŸ”µ REFACTOR"
